-- Manuelle Korrekturbuchungen

-- VIEW erstellen
------------------------------------------------------------------------------------------------------------------------
drop view CALC.VIEW_CASH_FLOW_PAST_MANUAL_CORRECTIONS;
create or replace view CALC.VIEW_CASH_FLOW_PAST_MANUAL_CORRECTIONS(CUT_OFF_DATE, FACILITY_ID,CASH_FLOW_TYPE,TRANSACTION_VALUE_TRADECURRENCY,TRANSACTION_TRADECURRENCY_ISO,VALUTA_DATE,PAYMENT_DATE,ERFOLGSART,SOURCE_SYSTEM,PAST_DUE_ALIAS,TRANSACTION_ID,CANCELLATION_TRANSACTION_ID,IS_BAD_DEBT_LOSS,COMMENT,CREATED_USER,CREATED_TIMESTAMP) as
with
    CUT_OFF_DATES as (
        select
            DATA_CUT_OFF_DATE AS CUT_OFF_DATE,
            row_number() over (order by DATA_CUT_OFF_DATE desc) as NBR
        from (select distinct DATA_CUT_OFF_DATE from CALC.SWITCH_PORTFOLIO_ARCHIVE)
    ),
    MANUAL_CORRECTIONS as (
        select distinct *
        from (
            values
                ('0009-33-004250152830-30-0000000000','KORREKTUR PRINCIPAL',-57000,'EUR','01.01.2019','31.12.2018',NULL,'30.06.2019','SWB_KORR_LIQ_01_20181231',NULL)
                ,('0009-33-004250152830-30-0000000000','KORREKTUR INTEREST',78055,'USD','21.05.2019','21.05.2019',NULL,'30.06.2019','SWB_KORR_LIQ_01_20181231',NULL)
                ,('0009-33-004250084110-31-0000000000','KORREKTUR RS TILGUNGSZAHLUNG',+12500000,'EUR','28.12.2019','25.02.2019',NULL,'30.06.2019','SWB_KORR_LIQ_01_20181228',NULL)
                ,('0009-33-004250147810-31-0000000000','KORREKTUR RS TILGUNGSZAHLUNG',-4064.959999999942,'EUR','19.09.2018','29.04.2019',NULL,'30.06.2019','SWB_KORR_LIQ_01_20180919',NULL)
                ,('0009-71-004531602026-10-0000000000','KORREKTUR MIDAS MIGRATION NYC',-62066.63,'USD','27.06.2019','21.06.2019',NULL,'30.06.2019','SWB_KORR_NYC_01_20190627',NULL)
                --,('0009-73-004533007771-10-0000000000','KORREKTUR MIDAS Fehlender Eigenanteil SIN',+5596099.05,'USD','01.01.2019','31.12.2018','30.06.2019','SWB_KORR_SIN_01_20190331',NULL)
                --,('0009-73-004533007771-10-0000000000','KORREKTUR Fehlender Eigenanteil SIN',-6407533.41+6130575.04,'USD','31.03.2019','31.03.2019',NULL,'30.06.2019','SWB_KORR_SIN_01_20190331',NULL) --korrigiert über einrechnen des syndizuerngsanteils
                --,('0009-73-004533007771-10-0000000000','KORREKTUR Fehlender Eigenanteil SIN',-6130575.04+5849702.77,'USD','30.06.2019','30.06.2019',NULL,'30.06.2019','SWB_KORR_SIN_01_20190630',NULL)  --korrigiert über einrechnen des syndizuerngsanteils
                ,('0009-73-004533007772-10-0000000000','KORREKTUR DOPPELTE Buchung SIN',-1044385.92,'USD','03.04.2019','02.04.2019',NULL,'30.06.2019','SWB_KORR_SIN_01_20190630',NULL)
                ---
                ,('K028-2655293_1020','KORREKTUR FALSCHE STORNO in SCHNITTSTELLE',725000,'USD','23.01.2019','24.01.2019',NULL,'30.06.2019','SWB_KORR_CBB_01_20190630',NULL)
                ,('K028-2655293_1020','KORREKTUR FALSCHE STORNO in SCHNITTSTELLE',725000,'USD','23.01.2019','25.01.2019',NULL,'30.06.2019','SWB_KORR_CBB_02_20190630',NULL)
                --
                ,('0009-71-004531602026-10-0000000000','KORREKTUR MIDAS MIGRATION NYC',-124133.48,'USD','01.07.2019','09.08.2019',NULL,'30.09.2019','SWB_KORR_NYC_01_20190809',NULL)
                ,('0009-71-004531602026-10-0000000000','KORREKTUR MIDAS MIGRATION NYC',-124133.48,'USD','01.07.2019','05.07.2019',NULL,'30.09.2019','SWB_KORR_NYC_01_20190705',NULL)
                ,('0009-73-004533008802-10-0000000000','KORREKTUR MIDAS MIGRATION KONSORTIALANTEIL SGP',4295.851749791647,'USD','01.07.2019','01.07.2019',NULL,'30.09.2019','SWB_KORR_SGP_01_20190701',NULL)
                ,('0009-73-004533008798-10-0000000000','KORREKTUR MIDAS MIGRATION KONSORTIALANTEIL SGP',4307.293385768076,'USD','01.07.2019','01.07.2019',NULL,'30.09.2019','SWB_KORR_SGP_02_20190701',NULL)
                ,('0009-33-004250036840-31-0000000000','KORREKTUR FEHLERHAFTE BUCHUNG',569.97,'USD','30.09.2019','30.09.2019',NULL,'30.09.2019','SWB_KORR_LIQ_01_20190930',NULL)
                ,('0009-33-004250095680-31-0000000000','KORREKTUR FEHLENDE STORNO TILGUNG',-29913954.880000003,'USD','27.09.2019','27.09.2019',NULL,'30.09.2019','SWB_KORR_LIQ_02_20190930',NULL)
                ,('0009-33-004250095690-31-0000000000','KORREKTUR FEHLENDE STORNO TILGUNG',-24977860.89999999,'USD','27.09.2019','27.09.2019',NULL,'30.09.2019','SWB_KORR_LIQ_03_20190930',NULL)
                ,('0009-33-004250096040-31-0000000000','KORREKTUR FEHLENDE STORNO TILGUNG',-232727.2799999998,'USD','27.09.2019','27.09.2019',NULL,'30.09.2019','SWB_KORR_LIQ_04_20190930',NULL)
                ,('0009-33-004250109920-31-0000000000','KORREKTUR FEHLENDE STORNO TILGUNG',-6097212.01,'USD','27.09.2019','27.09.2019',NULL,'30.09.2019','SWB_KORR_LIQ_05_20190930',NULL)
                ,('0009-33-004250142330-31-0000000000','KORREKTUR FEHLENDE STORNO TILGUNG',1599175.1,'USD','26.08.2019','05.09.2019',NULL,'30.09.2019','SWB_KORR_LIQ_05_20190930',NULL)
                ,('0009-33-004250142330-31-0000000000','KORREKTUR PRINCIPAL AUS PAST DUE',-9938554.5,'USD','26.06.2019','05.07.2019',NULL,'30.09.2019','SWB_KORR_LIQ_05_20190930',NULL)
        ) as MANUELLE_UMSATZ_KORREKTUREN ( FACILITY_ID,UMSATZ_ART,TRANSAKTION_WERT_WHRG,TRANSAKTION_WHRG_SCHL,VALUTA_DATUM,BUCHUNGS_DATUM,ERFOLGSART,CUT_OFF_DATE,BUCHUNGS_ID,STORNO_BUCHUNGS_ID)
    )
select
    MANUAL_CORRECTIONS.CUT_OFF_DATE as CUT_OFF_DATE,
    MANUAL_CORRECTIONS.FACILITY_ID  as FACILITY_ID,
    UMSATZ_ART              as CASH_FLOW_TYPE,
    TRANSAKTION_WERT_WHRG   as TRANSACTION_VALUE_TRADECURRENCY,
    TRANSAKTION_WHRG_SCHL   as TRANSACTION_TRADECURRENCY_ISO,
    VALUTA_DATUM            as VALUTA_DATE,
    BUCHUNGS_DATUM          as PAYMENT_DATE,
    ERFOLGSART              as ERFOLGSART, -- SPÄTER ÜBER MAPPING
    'Blossom'               as SOURCE_SYSTEM,
    NULL                    as PAST_DUE_ALIAS,
    BUCHUNGS_ID             as TRANSACTION_ID,
    STORNO_BUCHUNGS_ID      as CANCELLATION_TRANSACTION_ID,
    cast(NULL as BOOLEAN)   as IS_BAD_DEBT_LOSS, -- Handelt es sich um eine Abschreibung?  (siehe Blossom #541)
    'Manuelle Korrektur'    as COMMENT,
    Current USER            as CREATED_USER,          -- Letzter Nutzer, der dieses View gebaut hat.
    Current TIMESTAMP       as CREATED_TIMESTAMP      -- Neuester Zeitstempel, wann diese View zuletzt gebaut wurde.
from MANUAL_CORRECTIONS
left join CUT_OFF_DATES on MANUAL_CORRECTIONS.CUT_OFF_DATE = CUT_OFF_DATES.CUT_OFF_DATE
where CUT_OFF_DATES.NBR = 1
;
------------------------------------------------------------------------------------------------------------------------
